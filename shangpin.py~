# coding=gbk
from tkinter import *
from tkinter.ttk import *
import tkinter.font as tkFont
import pdb
import os
import re

from config import *
from finalsmap import *

#### Open File
articleName = None
for fileName in os.listdir():
    if re.match(r'\w*\.txt', fileName) :
        articleName = fileName
        break
if articleName == None:
    exit()
articleContent = open(articleName, 'r').read()
articleLineNumber = len(articleContent) // x_size

#### Window Init
typeWindow = Tk()
normalFont = tkFont.Font(family=fontName,
                         size=fontSize)

#### Font Init
kanjiWidth=int(normalFont.measure('Äã'))
realfontHeight = 1*fontSize
realFontSize = 1*fontSize

#### Display Widget(Binded)
displayArray = [StringVar() for i in range(min(y_size, articleLineNumber))]
for i in range(min(y_size, articleLineNumber)):
    displayBar = Label(typeWindow)
    displayBar.config(justify="right",
                      font="{} {}".format(fontName, fontSize),
                      textvariable=displayArray[i])
    displayBar.pack(padx=padding,pady=margin)
    displayArray[i].set(articleContent[i*x_size:(i+1)*x_size])

from pypinyin import pinyin, Style
x_pointer = -1
y_pointer = 0
positionFlag = 0
avaliableList = []
tempAvaliableList = []
tempInitialsList = pinyin(displayArray[0].get()[0],strict=False,
                          style=Style.INITIALS, heteronym=True)
tempFinalsList = pinyin(displayArray[0].get()[0],strict=False,
                        style=Style.FINALS, heteronym=True)
for i in range(len(tempInitialsList)):
    tempAvaliableList.append([tempInitialsList[i], tempFinalsList[i]])
for i in tempAvaliableList:
    print(i)
    if i[0][0] == '':
        avaliableList.append(singleFinalsMap[i[1][0]])
    else:
        avaliableList.append([doubleFinalsMap[i[0][0]],doubleFinalsMap[i[1][0]]])
def keyListener(event):
    global avaliableList
    global positionFlag
    global x_pointer
    global y_pointer
    key = event.char
    success = False
    for i in range(len(avaliableList)):
        if avaliableList[i][positionFlag] == key:
            success = True
    if not success:
        return
    positionFlag += 1
    if positionFlag == 2:
        positionFlag = 0
        x_pointer += 1
        if x_pointer == x_size:
            x_pointer = 0
            y_pointer += 1
            pass

        tempList = list(displayArray[y_pointer].get())
        tempList[x_pointer] = '¡¡'
        displayArray[y_pointer].set(''.join(tempList))
        
        avaliableList = []
        tempAvaliableList = []
        tempInitialsList = pinyin(displayArray[y_pointer].get()[x_pointer],
                                  style=Style.INITIALS, heteronym=True, strict=False)
        tempFinalsList = pinyin(displayArray[y_pointer].get()[0],
                                style=Style.FINALS, heteronym=True, strict=False)

        for i in range(len(tempInitialsList)):
            tempAvaliableList.append([tempInitialsList[i], tempFinalsList[i]])
        for i in tempAvaliableList:
            print('i={}'.format(i))
            print('tempAvaliableList:{}'.format(tempAvaliableList))
            if i[0][0] == '':
                avaliableList.append(singleFinalsMap[i[1][0]])
            else:
                avaliableList.append([doubleFinalsMap[i[0][0]],
                             doubleFinalsMap[i[1][0]]])
typeWindow.bind("<Key>", keyListener)
mainloop()
        
